<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Sixnature Loyalty</title>
  <link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/hiencamcam02/point.github.io/main/favicon.ico">
  <!-- Dùng CSS build sẵn -->
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-green-50 min-h-screen flex items-center justify-center p-4">
  <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-green-700 mb-6 text-center">
      🌿 Sixnature Loyalty
    </h1>

    <!-- Form tìm kiếm -->
    <label class="block mb-2 text-gray-600">📱 Số điện thoại</label>
    <div class="flex mb-4">
      <input id="phone" type="text" placeholder="Nhập số điện thoại"
        class="flex-1 p-2 border rounded-l-lg focus:outline-none">
      <button onclick="searchCustomer()"
        class="bg-green-600 hover:bg-green-700 text-white px-4 rounded-r-lg">
        Tìm
      </button>
    </div>

    <!-- Hiển thị kết quả -->
    <div id="customerInfo" class="hidden mb-4 p-3 bg-green-100 rounded-lg"></div>

    <!-- Thêm khách hàng mới -->
    <div id="newCustomerFields" class="hidden">
      <label class="block mb-2 text-gray-600">👤 Họ tên</label>
      <input id="name" type="text" placeholder="Nhập tên khách hàng"
        class="w-full p-2 border rounded mb-4">
    </div>

    <!-- Nhập điểm -->
    <label class="block mb-2 text-gray-600">⭐ Điểm tích</label>
    <input id="points" type="number" placeholder="+10 hoặc -5"
      class="w-full p-2 border rounded mb-4">

    <button onclick="savePoints()"
      class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">
      💾 Lưu điểm
    </button>

    <div id="message" class="mt-6 text-center text-gray-700"></div>
  </div>

  <script>
    const API_URL = "https://your-worker.workers.dev"; // 🔥 thay bằng Worker URL thật

    let currentCustomer = null;

    async function searchCustomer() {
      const phone = document.getElementById("phone").value.trim();
      if (!phone) {
        alert("Vui lòng nhập số điện thoại");
        return;
      }

      document.getElementById("message").textContent = "⏳ Đang tìm...";
      try {
        const res = await fetch(`${API_URL}?phone=${phone}`);
        const data = await res.json();

        const infoBox = document.getElementById("customerInfo");
        const newFields = document.getElementById("newCustomerFields");

        if (Object.keys(data).length === 0) {
          infoBox.classList.remove("hidden");
          infoBox.innerHTML = `<p class="text-red-600">Không tìm thấy khách hàng. Vui lòng nhập tên để thêm mới.</p>`;
          newFields.classList.remove("hidden");
          currentCustomer = { phone };
        } else {
          infoBox.classList.remove("hidden");
          newFields.classList.add("hidden");
          infoBox.innerHTML = `
            <p><strong>👤 Tên:</strong> ${data.name}</p>
            <p><strong>📱 SĐT:</strong> ${data.phone}</p>
            <p><strong>⭐ Tổng điểm:</strong> ${data.points}</p>
          `;

          if (data.history && data.history.length > 0) {
            infoBox.innerHTML += "<p class='mt-2 font-semibold'>📜 Lịch sử gần đây:</p>";
            infoBox.innerHTML += "<ul class='list-disc ml-5 text-sm'>";
            data.history.slice(-5).reverse().forEach(h => {
              const date = new Date(h.time).toLocaleString("vi-VN");
              infoBox.innerHTML += `<li>${h.change > 0 ? "+" : ""}${h.change} điểm lúc ${date}</li>`;
            });
            infoBox.innerHTML += "</ul>";
          }

          currentCustomer = data;
        }

        document.getElementById("message").textContent = "";
      } catch (err) {
        console.error(err);
        document.getElementById("message").textContent = "❌ Lỗi khi tìm khách hàng";
      }
    }

    async function savePoints() {
      if (!currentCustomer) {
        alert("Vui lòng tìm khách hàng trước");
        return;
      }

      const phone = currentCustomer.phone;
      const name = document.getElementById("name").value.trim() || currentCustomer.name || "";
      const change = parseInt(document.getElementById("points").value);

      if (!change) {
        alert("Vui lòng nhập số điểm (có thể là âm hoặc dương)");
        return;
      }

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, name, change })
        });
        const data = await res.json();

        alert(`✅ Lưu thành công! Tổng điểm mới của ${data.name} (${data.phone}) là ${data.points}`);
        location.reload();
      } catch (err) {
        console.error(err);
        alert("❌ Lỗi khi lưu điểm");
      }
    }
  </script>
</body>
</html>
